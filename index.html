<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è—¥å“åº«å­˜æ¨¡æ“¬åˆ†æå·¥å…· v10.3</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        
        .config-box { background: #fdf2e9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #f0c38e; text-align: center; }
        .config-box label { font-weight: bold; font-size: 1.1em; color: #d35400; }
        .config-box input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 60px; text-align: center; font-size: 1.1em; }

        .upload-section { text-align: center; padding: 40px; border: 2px dashed #3498db; border-radius: 10px; background-color: #ecf8ff; margin-bottom: 30px; }
        .upload-btn { background-color: #3498db; color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background 0.3s; }
        .upload-btn:hover { background-color: #2980b9; }
        #fileInput { display: none; }
        
        .summary-section, .chart-section { display: none; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #34495e; color: white; }
        tr:hover { background-color: #f8f9fa; }
        
        .controls { margin: 25px 0; padding: 20px; background: #ecf0f1; border-radius: 8px; display: flex; align-items: center; gap: 15px; }
        select { padding: 10px; border-radius: 4px; border: 1px solid #bdc3c7; font-size: 16px; flex-grow: 1; outline: none; }
        
        .chart-container { position: relative; height: 500px; width: 100%; margin-top: 20px; }
        
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 0.85em; color: #fff; display: inline-block; }
        .badge-red { background-color: #e74c3c; }
        .diff-pos { color: #27ae60; font-weight: bold; }
        .diff-neg { color: #e74c3c; font-weight: bold; }
        .error-msg { color: #e74c3c; text-align: center; margin-top: 10px; font-weight: bold; }
        
        .rules-box { background: #e8f6f3; padding: 15px; border-radius: 5px; margin-bottom: 20px; font-size: 0.9em; line-height: 1.6; border-left: 4px solid #1abc9c; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’Š è—¥å“åº«å­˜æ¨¡æ“¬åˆ†æå·¥å…· v10.3</h1>
        
        <div class="config-box">
            <label for="ltInput">ğŸšš å» å•†åˆ°è²¨å¤©æ•¸ (Lead Time)ï¼š</label>
            <input type="number" id="ltInput" value="1" min="0"> 
            <span style="margin-left: 5px;">å¤©</span>
            <p style="font-size: 0.9em; color: #666; margin-top: 5px;">(0å¤© = ç•¶æ—¥è£œè²¨/éš¨å«éš¨åˆ°ï¼›1å¤© = éš”æ—¥åˆ°è²¨)</p>
        </div>

        <div class="upload-section" id="dropZone">
            <p style="font-size: 1.2em; color: #555; margin-bottom: 15px;">è«‹ä¸Šå‚³ CSV æª”æ¡ˆ (æ¨¡æ“¬Check.csv)</p>
            <input type="file" id="fileInput" accept=".csv">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ é¸æ“‡æª”æ¡ˆ</button>
            <p id="fileName" style="margin-top: 10px; color: #7f8c8d;"></p>
            <div id="errorMsg" class="error-msg"></div>
        </div>

        <div class="summary-section" id="summarySection">
            <h2 style="border-left: 5px solid #3498db; padding-left: 10px;">ğŸ“Š æ¨¡æ“¬æ•ˆç›Šç¸½è¦½</h2>
            
            <div class="rules-box">
                <strong>ğŸ“Œ v10.3 ä¿®æ­£é‚è¼¯ï¼š</strong><br>
                1. <strong>é–‹å±€æ€¥é ˜ä¿®æ­£</strong>ï¼šè‹¥åˆå§‹åº«å­˜ <= 0ï¼Œåˆ¤å®šç‚º <span style="color:#e74c3c">â˜… æ€¥é ˜</span>ã€‚<br>
                2. <strong>è£œè²¨æ•¸å€¼</strong>ï¼šå€åˆ†ã€Œç•¶æ—¥è£œè²¨ã€èˆ‡ã€Œé è¨ˆè£œè²¨ã€ã€‚<br>
                3. <strong>ç©©å®šæ€§</strong>ï¼šä¿ç•™ v10.2 çš„æ—¥æœŸå°é½Šèˆ‡é˜²éŒ¯æ©Ÿåˆ¶ã€‚
            </div>

            <table id="summaryTable">
                <thead>
                    <tr>
                        <th>é™¢å…§ç¢¼</th>
                        <th>è—¥å</th>
                        <th>èˆŠæ€¥é ˜ (Col C)</th>
                        <th>æ–°æ€¥é ˜ (æ¨¡æ“¬)</th>
                        <th>æ™®é€šè£œè²¨ (æ¬¡)</th>
                        <th>æ”¹å–„å·®ç•°</th>
                        <th>å‚™è¨»</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="chart-section" id="chartSection">
            <div class="controls">
                <label for="drugSelect"><strong>ğŸ“ˆ æŸ¥çœ‹é€æ—¥åº«å­˜èµ°å‹¢ï¼š</strong></label>
                <select id="drugSelect" onchange="updateChart()"></select>
            </div>
            <div class="chart-container">
                <canvas id="stockChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let simulationResults = {};
        let myChart = null;

        document.getElementById('ltInput').addEventListener('change', function(e) {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length > 0) {
                const event = new Event('change');
                fileInput.dispatchEvent(event);
            }
        });

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('fileName').textContent = `å·²é¸æ“‡æª”æ¡ˆ: ${file.name}`;
            document.getElementById('errorMsg').textContent = '';

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                encoding: "UTF-8", 
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        try {
                            runSimulation(results);
                            document.getElementById('summarySection').style.display = 'block';
                            document.getElementById('chartSection').style.display = 'block';
                        } catch (err) {
                            console.error(err);
                            document.getElementById('errorMsg').textContent = 'åŸ·è¡ŒéŒ¯èª¤: ' + err.message;
                        }
                    }
                }
            });
        });

        function parseNum(val) {
            if (!val) return 0;
            const cleanVal = val.toString().replace(/,/g, '').trim(); 
            const num = parseFloat(cleanVal);
            return isNaN(num) ? 0 : num;
        }

        function formatDateLabel(dateStr) {
            if (dateStr === '11/30') return '11/30';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr; 
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const d = date.getDate().toString().padStart(2, '0');
            return `${m}/${d}`;
        }

        function runSimulation(parsedResult) {
            const data = parsedResult.data;
            const fields = parsedResult.meta.fields;
            
            const LT = parseInt(document.getElementById('ltInput').value) || 0;

            const colID = fields[0];
            const colName = fields[1];
            const colOldUrgent = fields[2]; 
            const colInitStock = fields[3];
            const colMaxCap = fields[4];
            const colUnit = fields[5];
            const colMin = fields[6];
            const colSafety = fields[7];
            const colBasis = fields[8];

            let dateKeys = fields.filter(k => (k.includes('202') && (k.includes('-') || k.includes('/'))));
            if (dateKeys.length === 0) dateKeys = fields.slice(9); 
            dateKeys.sort((a, b) => new Date(a) - new Date(b));

            const tableBody = document.querySelector('#summaryTable tbody');
            const select = document.getElementById('drugSelect');
            tableBody.innerHTML = ''; 
            select.innerHTML = ''; 
            simulationResults = {}; 

            data.forEach(row => {
                const drugId = row[colID];
                const drugName = row[colName];
                if (!drugId) return;

                const oldUrgent = parseNum(row[colOldUrgent]);
                const initialStock = parseNum(row[colInitStock]);
                const requestUnit = parseNum(row[colUnit]) || 1;
                const minStock = parseNum(row[colMin]);
                const safetyStock = parseNum(row[colSafety]);
                const sysBasis = parseNum(row[colBasis]);
                
                const maxCapRaw = row[colMaxCap];
                let maxCap = 999999;
                let hasMaxCap = false;
                if (maxCapRaw && maxCapRaw.toString().trim() !== '') {
                    maxCap = parseNum(maxCapRaw);
                    hasMaxCap = true;
                }

                let currentStock = initialStock;
                let newUrgentCount = 0;
                let newRegularCount = 0; 
                let pendingQty = 0;
                let daysToArrival = -1;
                
                const triggerVal = Math.max(minStock, safetyStock);
                let targetLevel = hasMaxCap ? maxCap : Math.max(sysBasis, triggerVal);
                if (targetLevel <= triggerVal) targetLevel = triggerVal + requestUnit;

                const rawDates = ['11/30'].concat(dateKeys);
                const displayDates = rawDates.map(formatDateLabel);
                const dailyStock = [initialStock];
                const dailyConsumption = [0]; 
                
                const urgentPoints = []; 
                const regularPoints = [];

                let maxDataValue = initialStock; 

                // --- 1. é–‹å±€æª¢æŸ¥ (Day 0) ---
                let day0Urgent = { x: displayDates[0], y: null };
                let day0Regular = { x: displayDates[0], y: null };

                if (currentStock <= triggerVal) {
                    let diff = targetLevel - currentStock;
                    if (diff > 0) {
                        let qty = Math.ceil(diff / requestUnit) * requestUnit;
                        if (hasMaxCap && (currentStock + qty > maxCap)) {
                            let space = maxCap - currentStock;
                            qty = Math.floor(space / requestUnit) * requestUnit;
                        }
                        
                        let triggerLevel = currentStock; 
                        
                        // v10.3 ä¿®æ­£ï¼šè‹¥åˆå§‹ <= 0ï¼Œå¼·åˆ¶åˆ¤ç‚ºæ€¥é ˜
                        if (currentStock <= 0) {
                            newUrgentCount++; 
                            currentStock += qty; 
                            day0Urgent = { x: displayDates[0], y: currentStock, trigger: triggerLevel, qty: qty, isPending: false };
                        } else {
                            newRegularCount++;
                            currentStock += qty; 
                            day0Regular = { x: displayDates[0], y: currentStock, trigger: triggerLevel, qty: qty, isPending: false };
                        }
                    }
                }
                if (currentStock > maxDataValue) maxDataValue = currentStock;
                
                urgentPoints.push(day0Urgent);
                regularPoints.push(day0Regular);

                // --- 2. é€æ—¥æ¨¡æ“¬ ---
                dateKeys.forEach((date, i) => {
                    const currentDateLabel = displayDates[i + 1];
                    let dayUrgent = { x: currentDateLabel, y: null };
                    let dayRegular = { x: currentDateLabel, y: null };

                    const consumption = parseNum(row[date]);
                    dailyConsumption.push(consumption); 
                    if (consumption > maxDataValue) maxDataValue = consumption; 
                    
                    if (daysToArrival > 0) {
                        daysToArrival--;
                    }
                    if (daysToArrival === 0) {
                        currentStock += pendingQty;
                        pendingQty = 0;
                        daysToArrival = -1;
                    }

                    let isUrgent = false;
                    if (consumption > currentStock) {
                        isUrgent = true;
                        newUrgentCount++;
                    }

                    currentStock -= consumption;
                    if (currentStock < 0) currentStock = 0; 
                    
                    let isRegularRestock = false;
                    let restockQty = 0;
                    let triggerLevel = currentStock;

                    if (daysToArrival === -1 && currentStock <= triggerVal) {
                        let diff = targetLevel - currentStock;
                        if (diff > 0) {
                            let qty = Math.ceil(diff / requestUnit) * requestUnit;
                            if (hasMaxCap && (currentStock + qty > maxCap)) {
                                let space = maxCap - currentStock;
                                qty = Math.floor(space / requestUnit) * requestUnit;
                            }
                            
                            if (qty > 0) {
                                restockQty = qty;
                                if (LT === 0) {
                                    currentStock += qty;
                                    if (!isUrgent) {
                                        isRegularRestock = true; 
                                        newRegularCount++;
                                    }
                                } else {
                                    pendingQty = qty;
                                    daysToArrival = LT - 1; 
                                    if (!isUrgent) {
                                        isRegularRestock = true;
                                        newRegularCount++;
                                    }
                                }
                            }
                        }
                    }
                    
                    dailyStock.push(currentStock);
                    if (currentStock > maxDataValue) maxDataValue = currentStock;

                    if (isUrgent) {
                        dayUrgent = { x: currentDateLabel, y: currentStock, trigger: triggerLevel, qty: restockQty > 0 ? restockQty : "ç·Šæ€¥è£œè¶³", isPending: LT > 0 };
                    } else if (isRegularRestock) {
                        if (LT === 0) {
                            dayRegular = { x: currentDateLabel, y: currentStock, trigger: triggerLevel, qty: restockQty, isPending: false };
                        } else {
                            dayRegular = { x: currentDateLabel, y: triggerLevel, trigger: triggerLevel, qty: restockQty, isPending: true };
                        }
                    }
                    
                    urgentPoints.push(dayUrgent);
                    regularPoints.push(dayRegular);
                });

                maxDataValue = Math.ceil(maxDataValue * 1.1);

                simulationResults[drugId] = {
                    name: drugName,
                    dates: displayDates,
                    stockData: dailyStock,
                    consumptionData: dailyConsumption,
                    urgentData: urgentPoints,
                    regularData: regularPoints,
                    triggerVal: triggerVal,
                    maxCap: hasMaxCap ? maxCap : null,
                    maxValue: maxDataValue
                };

                const tr = document.createElement('tr');
                const diff = oldUrgent - newUrgentCount;
                let diffHtml = diff > 0 ? `<span class="diff-pos">â–¼ ${diff} (æ”¹å–„)</span>` : 
                               (diff < 0 ? `<span class="diff-neg">â–² ${Math.abs(diff)} (æƒ¡åŒ–)</span>` : `<span style="color:gray">-</span>`);
                let noteHtml = (hasMaxCap && triggerVal >= maxCap) ? `<span class="badge badge-red">å®¹é‡ä¸è¶³</span>` : ``;

                tr.innerHTML = `<td>${drugId}</td><td>${drugName}</td><td>${oldUrgent}</td><td>${newUrgentCount}</td><td>${newRegularCount}</td><td>${diffHtml}</td><td>${noteHtml}</td>`;
                tableBody.appendChild(tr);

                const option = document.createElement('option');
                option.value = drugId;
                option.text = `${drugId} - ${drugName}`;
                select.appendChild(option);
            });

            if (select.options.length > 0) {
                select.selectedIndex = 0;
                updateChart();
            }
        }

        function updateChart() {
            const select = document.getElementById('drugSelect');
            const drugId = select.value;
            const data = simulationResults[drugId];
            if (!data) return;

            const ctx = document.getElementById('stockChart').getContext('2d');
            if (myChart) myChart.destroy();

            const triggerLine = new Array(data.dates.length).fill(data.triggerVal);
            const maxCapLine = data.maxCap ? new Array(data.dates.length).fill(data.maxCap) : [];
            const commonMax = data.maxValue;

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.dates,
                    datasets: [
                        {
                            type: 'line',
                            label: 'åº«å­˜é‡',
                            data: data.stockData,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: true,
                            pointRadius: (ctx) => (ctx.dataIndex === 0 ? 5 : 0),
                            pointBackgroundColor: (ctx) => (ctx.dataIndex === 0 ? '#3498db' : 'transparent'),
                            yAxisID: 'y',
                            order: 1
                        },
                        {
                            type: 'bar',
                            label: 'æ¯æ—¥è€—ç”¨',
                            data: data.consumptionData,
                            backgroundColor: 'rgba(52, 152, 219, 0.3)', 
                            borderColor: '#2980b9',
                            borderWidth: 1,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            type: 'line',
                            label: 'è§¸ç™¼ç·š',
                            data: triggerLine,
                            borderColor: '#f39c12',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            yAxisID: 'y',
                            order: 3
                        },
                        {
                            type: 'line',
                            label: 'å®¹é‡ä¸Šé™',
                            data: maxCapLine,
                            borderColor: '#e74c3c',
                            borderWidth: 1,
                            borderDash: [2, 2],
                            pointRadius: 0,
                            fill: false,
                            hidden: !data.maxCap,
                            yAxisID: 'y',
                            order: 3
                        },
                        {
                            type: 'line', 
                            label: 'æ€¥é ˜ (Stockout)',
                            data: data.urgentData,
                            backgroundColor: '#e74c3c',
                            borderColor: '#e74c3c',
                            pointStyle: 'star',
                            pointRadius: 12,
                            showLine: false,
                            yAxisID: 'y',
                            order: 0
                        },
                        {
                            type: 'line',
                            label: 'æ™®é€šç”³é ˜ (Restock)',
                            data: data.regularData,
                            backgroundColor: '#3498db',
                            borderColor: '#2980b9',
                            pointStyle: 'circle',
                            pointRadius: 6,
                            showLine: false,
                            yAxisID: 'y',
                            order: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: { display: true, text: `é€æ—¥åº«å­˜ vs è€—ç”¨èµ°å‹¢: ${data.name}`, font: { size: 18 } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (context.raw && context.raw.y !== undefined) {
                                        if (context.raw.qty !== undefined) {
                                            const type = context.dataset.label.includes('æ€¥é ˜') ? 'æ€¥é ˜' : 'æ™®é€šç”³é ˜';
                                            const afterStock = context.raw.isPending ? context.raw.trigger + context.raw.qty : context.raw.y;
                                            const note = context.raw.isPending ? " (é è¨ˆ)" : "";
                                            label += `: è§¸ç™¼:${context.raw.trigger} â” è£œå¾Œ${note}:${afterStock} (è£œè²¨é‡: +${context.raw.qty})`;
                                        } else {
                                            label += ': ' + context.raw.y;
                                        }
                                    } else if (typeof context.raw === 'number') {
                                        label += ': ' + context.raw;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { autoSkip: true, maxRotation: 0, maxTicksLimit: 15 },
                            grid: { offset: true }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'æ•¸é‡ (åº«å­˜/è€—ç”¨)' },
                            beginAtZero: true,
                            max: commonMax
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
